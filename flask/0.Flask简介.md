# Flask简介

## 需要安装的包

```python
pip install flask
pip install flask-script
pip install flask-bootstrap # 页面
pip install flask-moment # 时间
pip install flask-wtf # 表单
pip install flask-sqlalchemy # 操作数据库
```

## Flask有两个主要依赖

路由、调试和Web服务器网关接口（Web Server Gateway Interface, WSGI）子系统由Werkzeug（http://werkzeug.pocoo.org/）提供；模板系统由Jinja2（http://jinja.pocoo.org/）提供。

初始化


## 程序的基本结构

### 初始化

```python
from flask import Flask
app = Flask(__name__)
```

### 路由和视图函数

```python
@app.route('/')
def index():
    return "Hello baoshanfangyuan!"

@app.route('/user/<name>')
def user(name):
    return 'hello %s' % name 
```

### 启动服务器

程序实例用run方法启动Flask集成的开发Web服务器

```python
if __name__ == "__main__":
    app.run(debug=True)
```

### 请求响应循环

Flask中有两种上下文：程序上下文和请求上下文。

| 变量名      | 上下文     | 说明                                                   |
| ----------- | ---------- | ------------------------------------------------------ |
| current_app | 程序上下文 | 当前激活程序的程序实例                                 |
| g           | 程序上下文 | 处理请求时用作临时存储的对象。每次请求都会重设这个变量 |
| request     | 请求上下文 | 请求对象，封装了客户端发出的HTTP请求中的内容           |
| session     | 请求上下文 | 用户会话，用于存储请求之间需要“记住”的值的词典         |

### 请求钩子

请求钩子使用修饰器实现，Flask支持以下4种钩子。

| 名称                 | 说明                                                         |
| -------------------- | ------------------------------------------------------------ |
| before_first_request | 注册一个函数，在处理第一个请求之前运行。                     |
| before_request       | 注册一个函数，在每次请求之前运行。                           |
| after_request        | 注册一个函数，如果没有未处理的异常抛出，在每次请求之后运行。 |
| teardown_request     | 注册一个函数，即使有未处理的异常抛出，也在每次请求之后运行。 |

### 常用函数

```python
from flask import Flask
from flask import request
from flask import make_response
from flask import redirect
from flask import abort

app = Flask(__name__)

@app.route('/')
def index():
    return "Hello baoshanfangyuan!"

@app.route('/agent')
def index2():
    user_agent = request.headers.get('User-Agent')
    return 'Your browser is %s ' % user_agent

@app.route('/cookie')
def index3():
    response = make_response('This document carries a cookie!')
    response.set_cookie('answer', '42')
    return response

@app.route('/redirect')
def index4():
    return redirect('https://www.taobao.com/')

@app.route('/abort')
def get_user():
    abort(404)

@app.route('/user/<name>')
def user(name):
    return 'hello %s' % name

if __name__ == "__main__":
    app.run(debug=True)
```

### 启动服务器

```python
python flaskexample.py runserver --host 0.0.0.0
```

## 模板

### 简单示例

视图函数的作用：生成请求的响应。

函数的作用：业务逻辑和表现逻辑。

jinja2模板引擎；

主目录下新建templates文件夹，index.html和user.html军方在templates文件夹下。

index.html文件内容

```html
<body>
    <h1>hello baoshan!</h1>
</body>
```

user.html文件内容

```html
<body>
    <h1>你好, {{name}}!</h1>
</body>
```

主文件内容

```python
from flask import Flask
from flask import render_template

app = Flask(__name__)

@app.route('/renderindex')
def renderindex():
    return render_template('index.html')

@app.route('/renderuser/<name>')
def renderuser(name):
    return render_template('user.html', name=name)

if __name__ == "__main__":
    app.run(debug=True)
```

### 常用部分过滤器

| 过滤器名   | 说明                                       |
| ---------- | ------------------------------------------ |
| safe       | 渲染值时不转义                             |
| capitalize | 把值的首字母转换成大写，其他字母转换成小写 |
| lower      | 把值转换成小写形式                         |
| upper      | 把值转换成大写形式                         |
| title      | 把值中每个单词的首字母都转换成大写         |
| trim       | 把值的首尾空格去掉                         |
| striptags  | 渲染之前把值中所有的HTML标签都删掉         |

### 控制结构

```html
{% if user %}
	Hello, {{user}}!
{% else %}
	Hello, Stranger!
{% endif %}
```

```html
<ul>
	{% for comment in comments %}
    	<li> {{ comment }} </li>
    {% endfor %}
</ul>
```

Jinja2支持宏。类似于Python代码中的函数。

```html
{% macro render_comment(comment) %}
	<li>{{ comment }}</li>
{% endmacro %}
<ul>
	{% for comment in comments %}
    	<li> {{ render_comment(comment) }} </li>
    {% endfor %}
</ul>
```

为了重复使用宏，可以将其保存在单独的文件中，然后需要的时候导入：

```html
{% import 'macros.html' as macros %}
<ul>
	{% for comment in comments %}
    	<li> {{ macros.render_comment(comment) }} </li>
    {% endfor %}
</ul>
```

需要在多处重复使用的模板代码片段可以写入单独的文件，再包含在所有模板中，以避免重复：

```html
{% include 'common.html' %}
```

另一种重复使用代码的强大方式是模板继承。

```html
{% extends 'base.html' %}

{% block title %} {% endblock %}
```

Flask-Bootstrap基模板中定义的块：

| 块名         | 说明                     |
| ------------ | ------------------------ |
| doc          | 整个HTML文档             |
| html_attribs | <html>标签的属性         |
| html         | <html>标签中的内容       |
| head         | <head>标签中的内容       |
| title        | <title>标签中的内容      |
| metas        | 一组<meta>标签           |
| styles       | 层叠样式表定义           |
| body_attribs | <body>标签的属性         |
| body         | <body>标签中的内容       |
| navbar       | 用户定义的导航条         |
| content      | 用户定义的页面内容       |
| scripts      | 文档底部的JavaScript声明 |

### Flask-bootstrap的使用案例：

Python后台文件内容flaskexample.py：

```python
from flask import Flask
from flask import render_template
from flask_bootstrap import Bootstrap

app = Flask(__name__)
bootstrap = Bootstrap(app)

@app.route('/')
def renderindex():
    return render_template('index.html', name='baoshanfangyuan')

if __name__ == "__main__":
    app.run()
```

前面页面内容，index.html位于根目录的templates文件夹下：

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>index</title>
</head>

<body>
    {% extends 'bootstrap/base.html' %}
    <h1>Hello, {{ name }}.</h1>
</body>

</html>
```

执行命令：

```python
python flaskexample.py runserver --host 0.0.0.0
```

Flask-Bootstrap的块，如果直接重定义可能会导致问题，需如下定义script块：

```html
{% block scripts %}
{{ super() }}
<script type="text/javascript" src="my-script.js"></script>
{% endblock %}
```

### Flask-moment本地化日期和时间

Python后台文件内容flaskexample.py：

```python
from flask import Flask
from flask_moment import Moment
from datetime import datetime

app = Flask(__name__)
moment = Moment(app)

@app.route('/')
def renderindex():
    return render_template('index.html', 
    name='baoshanfangyuan',
    current_time = datetime.utcnow())

if __name__ == "__main__":
    # app.run(debug=True)
    app.run()
```

前面页面内容，index.html位于根目录的templates文件夹下：

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>index</title>
</head>

<body>
    {% block content %}
    	<h1>Hello, {{ name }}.</h1>
    {% endblock %}
    
    {% block scripts %}
        {{ super() }}
        {{ moment.include_moment() }}
        <p>The local date and time is {{ moment(current_time).format('LLL') }}</p>
        <p>That was {{ moment(current_time).fromNow(refresh=True) }}</p>
    {% endblock %}
</body>

</html>
```

执行命令：

```python
python flaskexample.py runserver --host 0.0.0.0
```

### 自定义错误页面

```python
@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500
```

## Web表单

### 跨站请求保护

request.form能获取post请求中提交的表单数据

Flask-wtf能保护所有表单免受跨站请求伪造（Cross-Site Request Forgery, CSRF）的攻击。需要设置一个密钥：

```python
app = Flask(__name__)
app.config['SECRET_KEY'] = 'baoshan fangyuan'
```

### 表单类

定义一个表单

```python
from flask_wtf import Form
from wtforms import StringField, SubmitField
from wtforms.validators import Required

class NameForm(Form):
    name = StringField('What is your name?', validators=[Required()])
    submit = SubmitField('Submit')
```

WTForms支持的HTML标准字段：

| 字段类型            | 说明                                |
| ------------------- | ----------------------------------- |
| StringField         | 文本字段                            |
| TextAreaField       | 多行文本字段                        |
| PasswordField       | 密码文本字段                        |
| HiddenField         | 隐藏文本字段                        |
| DateField           | 文本字段，值为datetime.data格式     |
| DateTimeField       | 文本字段，值为datetime.datetime格式 |
| IntegerField        | 文本字段，值为整数                  |
| DecimalField        | 文本字段，值为decimal.Decimal       |
| FloatField          | 文本字段，值为浮点数                |
| BooleanField        | 复选框，值为True和False             |
| RadioField          | 一组单选框                          |
| SelectField         | 下拉列表                            |
| SelectMultipleField | 下拉列表，可选择多个值              |
| FileField           | 文件上传字段                        |
| SubmitField         | 表单提交按钮                        |
| FormField           | 把表单作为字段嵌入另一个表单        |
| FieldList           | 一组制定类型的字段                  |

WTForms验证函数：

| 验证函数    | 说明                                                   |
| ----------- | ------------------------------------------------------ |
| Email       | 验证电子邮件地址                                       |
| EqualTo     | 比较两个字段的值；常用于要求输入两次密码进行确认的情况 |
| IPAddress   | 验证IPv4网络地址                                       |
| Length      | 验证输入字符串的长度                                   |
| NumberRange | 验证输入的值在数字范围内                               |
| Optional    | 无输入值时跳过其他验证函数                             |
| Required    | 确保字段中有数据                                       |
| Regexp      | 使用正则表达式验证输入值                               |
| URL         | 验证URL                                                |
| AnyOf       | 确保输入值在可选值列表中                               |
| NoneOf      | 确保输入值不在可选值列表中                             |

### 重定向和用户会话

HTML程序

```html
    <form action="" method="POST">
        {{ form.hidden_tag() }}
        {{ form.name.label }} {{ form.name(id='my-text-field') }}
        {{ form.submit() }}
    </form>
```

Python程序

```python
from flask_wtf import FlaskForm
from wtforms import StringField, SubmitField
from wtforms.validators import Required
from flask import Flask, render_template, session, redirect, url_for

app = Flask(__name__)
app.config['SECRET_KEY'] = 'hard to guess string'

class NameForm(FlaskForm):
    name = StringField('What is your name?', validators=[Required()])
    submit = SubmitField('Submit')

@app.route('/', methods=['GET', 'POST'])
def index():
    form = NameForm()
    if form.validate_on_submit():
        session['name'] = form.name.data
        return redirect(url_for('index'))
        
    return render_template('hello.htm', form=form, name=session.get('name'))

if __name__ == "__main__":
    app.run(debug=True)

```

- redirect()是个辅助函数，用来生成HTTP重定向响应。其参数是重定向的URL。
- url_for()是URL生成函数，使用URL映射生成URL，保证URL和定义的路由兼容，而且修改路由名字后，依然可用。

使用上面的程序，刷新浏览器页面时，就不会出现警告了（刷新页面时，浏览器会重新发送之前已经发送过的最后一个请求。如果这个请求是一个包含表单数据的POST请求，刷新页面后会再次提交表单。本程序解决了这个问题。）

### Flash消息

此为Flask的核心特性。请求完成后，有时需要让用户知道状态发生了变化。可以使用确认消息、警告或者错误提醒。flash()函数可以实现这种效果。

HTML程序

```html
 <form action="" method="POST">
        {{ form.hidden_tag() }}
        {{ form.name.label }} {{ form.name(id='my-text-field') }}
        {{ form.submit() }}
        <br>
        {% for message in get_flashed_messages() %}
            {{ message }}
        {% endfor %}
    </form>
```

- get_flashed_messages()函数获取的消息在下次调用时不再返回，因此Flash消息只显示一次。

Python程序

```python
from flask_wtf import FlaskForm
from wtforms import StringField, SubmitField
from wtforms.validators import Required
from flask import Flask, render_template, session, redirect, url_for, flash

app = Flask(__name__)
app.config['SECRET_KEY'] = 'hard to guess string'

class NameForm(FlaskForm):
    name = StringField('What is your name?', validators=[Required()])
    submit = SubmitField('Submit')

@app.route('/', methods=['GET', 'POST'])
def index():
    form = NameForm()
    if form.validate_on_submit():
        old_name = session.get('name')
        if old_name is not None and old_name != form.name.data:
            flash('Looks like you have changed your name!'+"to " + form.name.data)
        session['name'] = form.name.data
        return redirect(url_for('index'))
    return render_template('hello.htm', form=form, name=session.get('name'))

if __name__ == "__main__":
    app.run(debug=True)

```

## 数据库

数据库框架选择考虑的因素如下：

- 易用性
- 性能
- 可移植性
- Flask集成度，节省编写集成代码的时间

### 使用Flask-SQLAlchemy管理数据库

Flask-SQLAlchemy是一个Flask扩展，简化了在Flask程序中使用SQLAlchemy的操作。是一个很强大的关系型数据库框架，支持多种数据后台。提供了高层ORM，也提供了使用数据库原生SQL的低层功能。

在Flask-SQLAlchemy中，数据库使用URL指定。最流行的数据库引擎采用的数据库URL如下

Flask-SQLAlchemy数据库URL对照关系

| 数据库引擎        | URL                                              |
| ----------------- | ------------------------------------------------ |
| MySQL             | mysql://username:password@hostname/database      |
| Postgress         | postgresql://username:password@hostname/database |
| SQLite（Unix）    | sqlite:////absolute/path/to/database             |
| SQLite（Windows） | sqlite:///c:/absolute/path/to/database           |

SQLite不需要使用服务器，故不需指定hostname、username和password。

程序使用的数据库URI必须保存到Flask配置对象的SQLALCHEMY_DATABASE_URI键中。配置对象中的SQLALCHEMY_COMMIT_on_teardown键，将其设置为True，每次请求结束后都会自动提交数据库中的变动。

配置数据库示例：

```python
from flask_sqlalchemy import SQLAlchemy
import os 

basedir = os.path.abspath(os.path.dirname(__file__))

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(basedir, 'data.sqlite')
app.config['SQLALCHEMY_COMMIT_ON_TEARDOWN'] = True
db = SQLAlchemy(app)
```

db对象是SQLAlchemy类的实例，表示程序使用的数据库，同时还获得了Flask-SQLAlchemy提供的所有功能。

### 定义模型

```python
class Role(db.Model):
    __tablename__ = 'roles'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64), unique=True)

    def __repr__(self):
        return '<Role %r>' % self.name

class User(db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, index=True)
    
    def __repr__(self):
        return '<User %r>' % self.username
```

- 表名最好自己定义，以便遵守使用复数形式进行命名的约定。

最常用的SQLAlchemy列类型

| 类型名       | Python类型         | 说明                                                |
| ------------ | ------------------ | --------------------------------------------------- |
| Integer      | int                | 普通整数，一般是32位                                |
| SmallInteger | int                | 取值范围小的整数，一般是16位                        |
| BigInteger   | int或long          | 不限制精度的整数                                    |
| Float        | float              | 浮点数                                              |
| Numeric      | decimal.Decimal    | 定点数                                              |
| String       | str                | 变长字符串                                          |
| Text         | str                | 变长字符串，对较长或不限长度的字符串做了优化        |
| Unicode      | unicode            | 变长Unicode字符串                                   |
| UnicodeText  | unicode            | 变长Unicode字符串，对较长或不限长度的字符串做了优化 |
| Boolean      | bool               | 布尔值                                              |
| Date         | datetime.date      | 日期                                                |
| Time         | datetime.time      | 时间                                                |
| DateTime     | datetime.datetime  | 日期和时间                                          |
| Interval     | datetime.timedelta | 时间间隔                                            |
| Enum         | str                | 一组字符串                                          |
| PickleType   | 任何Python对象     | 自动使用Pickle序列化                                |
| LargeBinary  | str                | 二进制文件                                          |

db.Column中其余的参数指定属性的配置选项：

| 选项名      | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| primary_key | 如果设为True，这列就是表的主键                               |
| unique      | 如果设为True，这列不允许出现重复的值                         |
| index       | 如果设为True，为这列创建索引，提升查询效率                   |
| nullable    | 如果设为True，这列允许使用空值；如果设为False，这列不允许使用空值 |
| default     | 为这列定义默认值                                             |

- Flask-SQLAlchemy要求每个模型都要定义主键，经常命名为id。
- 通常模型都定义\__repr__方法，返回一个具有可读性字符串表示模型，方便测试和调用时使用。

### 关系
- 继续


