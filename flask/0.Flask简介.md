# Flask简介

```python
# 需要安装的包
pip install flask
pip install flask-script
pip install flask-bootstrap
pip install flask-moment
```

## Flask有两个主要依赖

路由、调试和Web服务器网关接口（Web Server Gateway Interface, WSGI）子系统由Werkzeug（http://werkzeug.pocoo.org/）提供；模板系统由Jinja2（http://jinja.pocoo.org/）提供。

初始化


## 程序的基本结构

### 初始化

```python
from flask import Flask
app = Flask(__name__)
```

### 路由和视图函数

```python
@app.route('/')
def index():
    return "Hello baoshanfangyuan!"

@app.route('/user/<name>')
def user(name):
    return 'hello %s' % name 
```

### 启动服务器

程序实例用run方法启动Flask集成的开发Web服务器

```python
if __name__ == "__main__":
    app.run(debug=True)
```

### 请求响应循环

Flask中有两种上下文：程序上下文和请求上下文。

| 变量名      | 上下文     | 说明                                                   |
| ----------- | ---------- | ------------------------------------------------------ |
| current_app | 程序上下文 | 当前激活程序的程序实例                                 |
| g           | 程序上下文 | 处理请求时用作临时存储的对象。每次请求都会重设这个变量 |
| request     | 请求上下文 | 请求对象，封装了客户端发出的HTTP请求中的内容           |
| session     | 请求上下文 | 用户会话，用于存储请求之间需要“记住”的值的词典         |

### 请求钩子

请求钩子使用修饰器实现，Flask支持以下4种钩子。

| 名称                 | 说明                                                         |
| -------------------- | ------------------------------------------------------------ |
| before_first_request | 注册一个函数，在处理第一个请求之前运行。                     |
| before_request       | 注册一个函数，在每次请求之前运行。                           |
| after_request        | 注册一个函数，如果没有未处理的异常抛出，在每次请求之后运行。 |
| teardown_request     | 注册一个函数，即使有未处理的异常抛出，也在每次请求之后运行。 |

### 常用函数

```python
from flask import Flask
from flask import request
from flask import make_response
from flask import redirect
from flask import abort

app = Flask(__name__)

@app.route('/')
def index():
    return "Hello baoshanfangyuan!"

@app.route('/agent')
def index2():
    user_agent = request.headers.get('User-Agent')
    return 'Your browser is %s ' % user_agent

@app.route('/cookie')
def index3():
    response = make_response('This document carries a cookie!')
    response.set_cookie('answer', '42')
    return response

@app.route('/redirect')
def index4():
    return redirect('https://www.taobao.com/')

@app.route('/abort')
def get_user():
    abort(404)

@app.route('/user/<name>')
def user(name):
    return 'hello %s' % name

if __name__ == "__main__":
    app.run(debug=True)
```

### 启动服务器

```python
python flaskexample.py runserver --host 0.0.0.0
```

## 模板

### 简单示例

视图函数的作用：生成请求的响应。

函数的作用：业务逻辑和表现逻辑。

jinja2模板引擎；

主目录下新建templates文件夹，index.html和user.html军方在templates文件夹下。

index.html文件内容

```html
<body>
    <h1>hello baoshan!</h1>
</body>
```

user.html文件内容

```html
<body>
    <h1>你好, {{name}}!</h1>
</body>
```

主文件内容

```python
from flask import Flask
from flask import render_template

app = Flask(__name__)

@app.route('/renderindex')
def renderindex():
    return render_template('index.html')

@app.route('/renderuser/<name>')
def renderuser(name):
    return render_template('user.html', name=name)

if __name__ == "__main__":
    app.run(debug=True)
```

### 常用部分过滤器

| 过滤器名   | 说明                                       |
| ---------- | ------------------------------------------ |
| safe       | 渲染值时不转义                             |
| capitalize | 把值的首字母转换成大写，其他字母转换成小写 |
| lower      | 把值转换成小写形式                         |
| upper      | 把值转换成大写形式                         |
| title      | 把值中每个单词的首字母都转换成大写         |
| trim       | 把值的首尾空格去掉                         |
| striptags  | 渲染之前把值中所有的HTML标签都删掉         |

### 控制结构

```html
{% if user %}
	Hello, {{user}}!
{% else %}
	Hello, Stranger!
{% endif %}
```

```html
<ul>
	{% for comment in comments %}
    	<li> {{ comment }} </li>
    {% endfor %}
</ul>
```

Jinja2支持宏。类似于Python代码中的函数。

```html
{% macro render_comment(comment) %}
	<li>{{ comment }}</li>
{% endmacro %}
<ul>
	{% for comment in comments %}
    	<li> {{ render_comment(comment) }} </li>
    {% endfor %}
</ul>
```

为了重复使用宏，可以将其保存在单独的文件中，然后需要的时候导入：

```html
{% import 'macros.html' as macros %}
<ul>
	{% for comment in comments %}
    	<li> {{ macros.render_comment(comment) }} </li>
    {% endfor %}
</ul>
```

需要在多处重复使用的模板代码片段可以写入单独的文件，再包含在所有模板中，以避免重复：

```html
{% include 'common.html' %}
```

另一种重复使用代码的强大方式是模板继承。

```html
{% extends 'base.html' %}

{% block title %} {% endblock %}
```

Flask-Bootstrap基模板中定义的块：

| 块名         | 说明                     |
| ------------ | ------------------------ |
| doc          | 整个HTML文档             |
| html_attribs | <html>标签的属性         |
| html         | <html>标签中的内容       |
| head         | <head>标签中的内容       |
| title        | <title>标签中的内容      |
| metas        | 一组<meta>标签           |
| styles       | 层叠样式表定义           |
| body_attribs | <body>标签的属性         |
| body         | <body>标签中的内容       |
| navbar       | 用户定义的导航条         |
| content      | 用户定义的页面内容       |
| scripts      | 文档底部的JavaScript声明 |

### Flask-bootstrap的使用案例：

Python后台文件内容flaskexample.py：

```python
from flask import Flask
from flask import render_template
from flask_bootstrap import Bootstrap

app = Flask(__name__)
bootstrap = Bootstrap(app)

@app.route('/')
def renderindex():
    return render_template('index.html', name='baoshanfangyuan')

if __name__ == "__main__":
    app.run()
```

前面页面内容，index.html位于根目录的templates文件夹下：

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>index</title>
</head>

<body>
    {% extends 'bootstrap/base.html' %}
    <h1>Hello, {{ name }}.</h1>
</body>

</html>
```

执行命令：

```python
python flaskexample.py runserver --host 0.0.0.0
```

Flask-Bootstrap的块，如果直接重定义可能会导致问题，需如下定义script块：

```html
{% block scripts %}
{{ super() }}
<script type="text/javascript" src="my-script.js"></script>
{% endblock %}
```

### Flask-moment本地化日期和时间

Python后台文件内容flaskexample.py：

```python
from flask import Flask
from flask_moment import Moment
from datetime import datetime

app = Flask(__name__)
moment = Moment(app)

@app.route('/')
def renderindex():
    return render_template('index.html', 
    name='baoshanfangyuan',
    current_time = datetime.utcnow())

if __name__ == "__main__":
    # app.run(debug=True)
    app.run()
```

前面页面内容，index.html位于根目录的templates文件夹下：

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>index</title>
</head>

<body>
    {% block content %}
    	<h1>Hello, {{ name }}.</h1>
    {% endblock %}
    
    {% block scripts %}
        {{ super() }}
        {{ moment.include_moment() }}
        <p>The local date and time is {{ moment(current_time).format('LLL') }}</p>
        <p>That was {{ moment(current_time).fromNow(refresh=True) }}</p>
    {% endblock %}
</body>

</html>
```

执行命令：

```python
python flaskexample.py runserver --host 0.0.0.0
```

### 自定义错误页面

```python
@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500
```

